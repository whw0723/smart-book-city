import{d as S,b as E,a as F,r as C,o as L,g as b,h as r,q as y,l as a,p as n,n as _,z as d,y as u,v as g,E as i,C as k,x as $,J as z,D as M,_ as N}from"./index-lJ9Ej1SP.js";const U={class:"cart-container"},D={key:0,class:"empty-cart"},Q={key:1,class:"cart-content"},J={class:"book-info"},P={class:"book-title"},R={class:"book-author"},j={class:"cart-footer"},A={class:"cart-summary"},G={class:"total-items"},H={class:"total-price"},K={class:"cart-actions"},O=S({__name:"Cart",setup(W){const v=$(),o=E(),h=F(),p=C(!1),w=C(!1);L(async()=>{if(h.isLoggedIn){w.value=!0;try{await o.fetchCart()}catch(s){console.error("获取购物车失败:",s)}finally{w.value=!1}}else o.loadFromLocalStorage()});const x=async(s,t)=>{try{await o.updateQuantity(s,t)}catch(l){console.error("更新购物车失败:",l),i.error("更新购物车失败")}},B=s=>{k.confirm("确定要从购物车中移除此商品吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await o.removeFromCart(s),i.success("商品已从购物车中移除")}catch(t){console.error("从购物车移除失败:",t),i.error("从购物车移除失败")}}).catch(()=>{})},I=()=>{k.confirm("确定要清空购物车吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await o.clearCart(),i.success("购物车已清空")}catch(s){console.error("清空购物车失败:",s),i.error("清空购物车失败")}}).catch(()=>{})},T=async()=>{var t,l;if(!h.isLoggedIn){k.confirm("请先登录后再结算","提示",{confirmButtonText:"去登录",cancelButtonText:"取消",type:"info"}).then(()=>{v.push("/login")}).catch(()=>{});return}if(o.items.length===0){i.warning("购物车为空，无法结算");return}p.value=!0;const s=z.service({lock:!0,text:"正在创建订单...",background:"rgba(0, 0, 0, 0.7)"});try{for(const c of o.items)await M.post("https://smart-book-city.onrender.com/api/orders/book",{userId:(t=h.user)==null?void 0:t.id,bookId:c.book.id,quantity:c.quantity});await o.clearCart(),i.success("订单创建成功！"),v.push("/orders")}catch(c){console.error("创建订单失败:",c),i.error(`创建订单失败: ${((l=c.response)==null?void 0:l.data)||c.message||"未知错误"}`)}finally{s.close(),p.value=!1}};return(s,t)=>{const l=_("el-button"),c=_("el-empty"),m=_("el-table-column"),V=_("el-input-number"),q=_("el-table");return g(),b("div",U,[t[5]||(t[5]=r("h1",{class:"page-title"},"我的购物车",-1)),y(o).items.length===0?(g(),b("div",D,[a(c,{description:"购物车为空"},{default:n(()=>[a(l,{type:"primary",onClick:t[0]||(t[0]=e=>s.$router.push("/home"))},{default:n(()=>t[1]||(t[1]=[u("去浏览图书")])),_:1})]),_:1})])):(g(),b("div",Q,[a(q,{data:y(o).items,style:{width:"100%"}},{default:n(()=>[a(m,{label:"图书"},{default:n(e=>[r("div",J,[r("div",null,[r("div",P,d(e.row.book.title),1),r("div",R,d(e.row.book.author),1)])])]),_:1}),a(m,{label:"单价",width:"120"},{default:n(e=>[u(" ¥"+d(e.row.book.price),1)]),_:1}),a(m,{label:"数量",width:"150"},{default:n(e=>[a(V,{modelValue:e.row.quantity,"onUpdate:modelValue":f=>e.row.quantity=f,min:1,max:20,step:1,onChange:f=>x(e.row.book.id,f),size:"small"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),a(m,{label:"小计",width:"120"},{default:n(e=>[u(" ¥"+d((e.row.book.price*e.row.quantity).toFixed(2)),1)]),_:1}),a(m,{label:"操作",width:"120"},{default:n(e=>[a(l,{type:"danger",size:"small",onClick:f=>B(e.row.book.id),text:""},{default:n(()=>t[2]||(t[2]=[u(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),r("div",j,[r("div",A,[r("div",G,"共 "+d(y(o).totalItems)+" 件商品",1),r("div",H,[t[3]||(t[3]=u("总计：")),r("span",null,"¥"+d(y(o).totalPrice.toFixed(2)),1)])]),r("div",K,[a(l,{onClick:I,plain:""},{default:n(()=>t[4]||(t[4]=[u("清空购物车")])),_:1}),a(l,{type:"primary",onClick:T,disabled:p.value},{default:n(()=>[u(d(p.value?"提交中...":"结算"),1)]),_:1},8,["disabled"])])])]))])}}}),Y=N(O,[["__scopeId","data-v-fc4c4eae"]]);export{Y as default};

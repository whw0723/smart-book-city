import{d as T,a as L,r as P,G as S,o as E,g as U,F as k,l,n as p,p as i,v as A,h as c,A as $,j as q,q as B,y as V,E as f,D as R,x as j,C as M,_ as O}from"./index-lJ9Ej1SP.js";const z={class:"nav-container"},J={class:"logo"},G={class:"nav-right"},H={class:"dialog-footer"},W=T({__name:"AdminNavbar",setup(K){const v=j(),a=L(),w=P(!1),_=P(!1),b=P(),t=S({currentPassword:"",newPassword:"",confirmPassword:""}),D=S({currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"},{min:6,message:"密码长度不能少于6个字符",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(y,r,s)=>{r!==t.newPassword?s(new Error("两次输入的密码不一致")):s()},trigger:"blur"}]});E(()=>{a.initializeFromLocalStorage()});const C=()=>{v.push("/admin")},N=()=>{w.value=!0,t.currentPassword="",t.newPassword="",t.confirmPassword=""},F=async()=>{b.value&&await b.value.validate(async y=>{var r;if(y){_.value=!0;try{a.initializeFromLocalStorage(),console.log("User store state after initialization:",{user:a.user,isLoggedIn:a.isLoggedIn,isAdmin:a.isAdmin});const s=localStorage.getItem("user"),d=localStorage.getItem("userType"),u=localStorage.getItem("lastAdminUsername");console.log("=== localStorage Debug ==="),console.log("user:",s),console.log("userType:",d),console.log("lastAdminUsername:",u),console.log("All localStorage keys:",Object.keys(localStorage));let o=null;if(console.log("UserStore state:",{user:a.user,isLoggedIn:a.isLoggedIn,isAdmin:a.isAdmin}),a.user&&(o=a.user.id||a.user.username,console.log("Case 1: User ID from userStore:",o)),!o&&s)try{const e=JSON.parse(s);console.log("Parsed user data from localStorage:",e),e&&typeof e=="object"&&(o=e.id||e.username||e._id||e.user_id,console.log("Case 2: User ID extracted from localStorage:",o),a.user=e,a.isLoggedIn=!0,a.isAdmin=d==="admin")}catch(e){console.error("Failed to parse user data from localStorage:",e),console.error("Raw user data string causing parse error:",s)}if(!o&&u&&(o=u,console.log("Case 3: Using lastAdminUsername as User ID:",o)),!o&&d==="admin"){for(const e of Object.keys(localStorage))if(e.includes("admin")||e.includes("user")){console.log(`Checking localStorage key: ${e}, value: ${localStorage.getItem(e)}`);const g=localStorage.getItem(e);if(g&&g.trim()!=="")try{const m=JSON.parse(g);if(m&&typeof m=="object"){const h=m.id||m.username||m._id||m.user_id;if(h){o=h,console.log(`Found potential ID from ${e}:`,o);break}}}catch{if(!g.startsWith("{")&&g.length>0){o=g,console.log(`Using ${e} value directly as ID:`,o);break}}}}if(console.log("Final userId value before validation:",o),console.log("Final userId type:",typeof o),!o||typeof o=="string"&&o.trim()===""){console.error("Final check failed: User ID is invalid or missing"),console.error("Available localStorage data:",{user:s,userType:d,lastAdminUsername:u}),f.error("用户信息无效或不完整，请重新登录");return}console.log("User ID validation passed:",o);let n=NaN;if(o!=null){if(typeof o=="number")n=o;else if(typeof o=="string"&&(n=parseInt(o,10),isNaN(n))){const e=o.match(/\d+/);e&&(n=parseInt(e[0],10))}}console.log("Using numeric user ID for API call:",n),isNaN(n)&&(console.error("Failed to convert user ID to number:",o),n=1,console.warn("Using default admin ID:",n));const I=await R.post(`https://smart-book-city.onrender.com/api/admin/${n}/change-password`,{currentPassword:t.currentPassword,newPassword:t.newPassword});f.success("密码已修改，请重新登录"),w.value=!1,t.currentPassword="",t.newPassword="",t.confirmPassword="",setTimeout(()=>{a.logout(),v.push("/login")},1500)}catch(s){console.error("Error during password change API call:",s),s.response?(console.error("Error response data:",s.response.data),console.error("Error status:",s.response.status),console.error("Error headers:",s.response.headers),f.error(`密码修改失败: ${((r=s.response.data)==null?void 0:r.message)||`HTTP ${s.response.status}`}，请确认当前密码是否正确`)):s.request?(console.error("No response received:",s.request),f.error("无法连接到服务器，请检查网络连接")):(console.error("Request setup error:",s.message),f.error("请求设置错误: "+s.message))}finally{_.value=!1}}})},x=()=>{M.confirm("确定要退出登录吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{a.logout(),f.success({message:"已退出登录",duration:1e3}),v.push("/login")}).catch(()=>{})};return(y,r)=>{const s=p("el-header"),d=p("el-input"),u=p("el-form-item"),o=p("el-form"),n=p("el-button"),I=p("el-dialog");return A(),U(k,null,[l(s,{class:"navbar"},{default:i(()=>[c("div",z,[c("div",J,[c("a",{onClick:$(C,["prevent"]),href:"/admin",class:"home-link"},"智慧书城管理系统")]),c("div",G,[B(a).isLoggedIn?(A(),U(k,{key:0},[c("button",{onClick:N,class:"nav-button"},"修改密码"),c("button",{onClick:x,class:"nav-button logout-button"},"退出登录")],64)):q("",!0)])])]),_:1}),l(I,{modelValue:w.value,"onUpdate:modelValue":r[4]||(r[4]=e=>w.value=e),title:"修改密码",width:"400px"},{footer:i(()=>[c("span",H,[l(n,{onClick:r[3]||(r[3]=e=>w.value=!1)},{default:i(()=>r[5]||(r[5]=[V("取消")])),_:1}),l(n,{type:"primary",onClick:F,loading:_.value},{default:i(()=>r[6]||(r[6]=[V("确认修改")])),_:1},8,["loading"])])]),default:i(()=>[l(o,{model:t,rules:D,ref_key:"passwordFormRef",ref:b,"label-width":"100px"},{default:i(()=>[l(u,{label:"当前密码",prop:"currentPassword"},{default:i(()=>[l(d,{modelValue:t.currentPassword,"onUpdate:modelValue":r[0]||(r[0]=e=>t.currentPassword=e),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),l(u,{label:"新密码",prop:"newPassword"},{default:i(()=>[l(d,{modelValue:t.newPassword,"onUpdate:modelValue":r[1]||(r[1]=e=>t.newPassword=e),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),l(u,{label:"确认新密码",prop:"confirmPassword"},{default:i(()=>[l(d,{modelValue:t.confirmPassword,"onUpdate:modelValue":r[2]||(r[2]=e=>t.confirmPassword=e),type:"password","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),X=O(W,[["__scopeId","data-v-fc6c9775"]]);export{X as A};

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookstore.mapper.CartItemMapper">

    <!-- 结果映射 -->
    <resultMap id="CartItemResultMap" type="com.bookstore.entity.CartItem">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="quantity" column="quantity"/>
        <!-- 图书关联 -->
        <association property="book" javaType="com.bookstore.entity.Book">
            <id property="id" column="book_id"/>
            <result property="title" column="title"/>
            <result property="author" column="author"/>
            <result property="price" column="price"/>
            <result property="stock" column="stock"/>
            <result property="category" column="category"/>
            <result property="description" column="description"/>
        </association>
    </resultMap>

    <!-- 查找用户的所有购物车项 -->
    <select id="findByUserId" resultMap="CartItemResultMap">
        SELECT ci.*, b.*
        FROM cart_items ci
        JOIN books b ON ci.book_id = b.id
        WHERE ci.user_id = #{userId}
    </select>

    <!-- 根据ID查找购物车项 -->
    <select id="findById" resultMap="CartItemResultMap">
        SELECT ci.*, b.*
        FROM cart_items ci
        JOIN books b ON ci.book_id = b.id
        WHERE ci.id = #{id}
    </select>

    <!-- 查找用户的特定图书的购物车项 -->
    <select id="findByUserIdAndBookId" resultMap="CartItemResultMap">
        SELECT ci.*, b.*
        FROM cart_items ci
        JOIN books b ON ci.book_id = b.id
        WHERE ci.user_id = #{userId} AND ci.book_id = #{bookId}
    </select>

    <!-- 保存购物车项 -->
    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO cart_items (user_id, book_id, quantity)
        VALUES (#{userId}, #{book.id}, #{quantity})
    </insert>

    <!-- 更新购物车项 -->
    <update id="update">
        UPDATE cart_items
        SET quantity = #{quantity}
        WHERE id = #{id}
    </update>

    <!-- 删除购物车项 -->
    <delete id="deleteById">
        DELETE FROM cart_items
        WHERE id = #{id}
    </delete>

    <!-- 删除用户的所有购物车项 -->
    <delete id="deleteByUserId">
        DELETE FROM cart_items
        WHERE user_id = #{userId}
    </delete>

    <!-- 删除用户的特定图书的购物车项 -->
    <delete id="deleteByUserIdAndBookId">
        DELETE FROM cart_items
        WHERE user_id = #{userId} AND book_id = #{bookId}
    </delete>
</mapper>
